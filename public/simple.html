<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Niveau d'Eau - Sablons</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background: white;
        color: black;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 2rem;
        text-align: center;
      }
      .logo {
        width: 200px;
        margin-bottom: 3rem;
      }
      .label {
        font-size: 3rem;
        font-weight: bold;
        margin-bottom: 2rem;
      }
      .level-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        margin: 2rem 0;
      }
      .level-value {
        font-size: 10rem;
        font-weight: bold;
        line-height: 1;
      }
      .trend-arrow {
        width: 100px;
        height: 100px;
        opacity: 0;
        transition: opacity 0.5s;
      }
      .trend-arrow.visible {
        opacity: 1;
      }
      .unit {
        font-size: 2.5rem;
        margin-top: 1rem;
      }
      .loading {
        opacity: 0.5;
      }
      @media (max-width: 768px) {
        .logo {
          width: 150px;
          margin-bottom: 2rem;
        }
        .label {
          font-size: 2rem;
        }
        .level-value {
          font-size: 6rem;
        }
        .trend-arrow {
          width: 70px;
          height: 70px;
        }
        .unit {
          font-size: 1.8rem;
        }
      }
    </style>
  </head>
  <body>
    <img src="/logo_bretagneplaisance.svg" alt="Bretagne Plaisance" class="logo" />
    
    <div class="label" id="labelText">Hauteur au dessus du seuil</div>
    
    <div class="level-display">
      <div class="level-value" id="levelValue">--,--</div>
      <div class="trend-arrow" id="trendArrow"></div>
    </div>
    
    <div class="unit" id="unitText">mètres</div>

    <script>
      (function() {
        'use strict';

        var API_URL = 'https://www.weincloud.net/dashboard/api/v2/published-dashboard/dc0b7a15-e32e-4dee-b193-8247579b656f/addresstag/get/value';
        
        var translations = {
          fr: { 
            label: 'Hauteur au dessus du seuil',
            unit: 'mètres', 
            error: 'ERREUR' 
          },
          en: { 
            label: 'Water level on the sill',
            unit: 'meters', 
            error: 'ERROR' 
          }
        };
        
        var currentLang = 'fr';
        var levelValue = null;
        var levelHistory = [];
        var maxHistoryLength = 20;
        var trend = 'stable';
        
        var labelElement = document.getElementById('labelText');
        var levelElement = document.getElementById('levelValue');
        var unitElement = document.getElementById('unitText');
        var trendElement = document.getElementById('trendArrow');

        var trendSVGs = {
          rising: '<svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 28V6M16 6L8 14M16 6L24 14" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
          falling: '<svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 4v22M16 26l8-8M16 26l-8-8" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
          stable: '<svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 16h20" stroke="black" stroke-width="2.5" stroke-linecap="round"/><path d="M24 16l-4-4M24 16l-4 4" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>'
        };

        function formatLevel(value, lang) {
          var locale = lang === 'fr' ? 'fr-FR' : 'en-US';
          return value.toLocaleString(locale, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
        }

        function setLang(lang) {
          currentLang = lang;
          labelElement.textContent = translations[lang].label;
          unitElement.textContent = translations[lang].unit;
          if (levelValue !== null) {
            levelElement.textContent = formatLevel(levelValue, lang);
          }
        }

        function analyzeTrend() {
          if (levelHistory.length < maxHistoryLength) return 'stable';
          var diff = levelHistory[levelHistory.length - 1] - levelHistory[0];
          if (diff > 0.01) return 'rising';
          if (diff < -0.01) return 'falling';
          return 'stable';
        }

        function updateTrendArrow() {
          if (levelHistory.length >= maxHistoryLength) {
            trendElement.innerHTML = trendSVGs[trend];
            trendElement.classList.add('visible');
          }
        }

        function fetchData() {
          levelElement.classList.add('loading');
          
          var payload = [
            { hmi_id: 168069, type: 'Float', name: 'NIVEAU_MER' }
          ];

          fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
          .then(function(res) {
            if (!res.ok) throw new Error('HTTP ' + res.status);
            return res.json();
          })
          .then(function(data) {
            var d = data.d || [];
            var niveauMer = d.find(function(i) { return i.name === 'NIVEAU_MER'; });
            if (!niveauMer) throw new Error('Donnée manquante');
            
            var value = parseFloat(niveauMer.values[0].value);
            levelValue = parseFloat(value.toFixed(2));
            levelElement.textContent = formatLevel(levelValue, currentLang);
            levelElement.classList.remove('loading');
            
            levelHistory.push(value);
            if (levelHistory.length > maxHistoryLength) {
              levelHistory.shift();
            }
            trend = analyzeTrend();
            updateTrendArrow();
          })
          .catch(function(e) {
            console.error(e);
            levelElement.textContent = translations[currentLang].error;
            levelElement.classList.remove('loading');
          });
        }

        setLang('fr');
        fetchData();
        
        setInterval(fetchData, 30000);
        
        setInterval(function() {
          setLang(currentLang === 'fr' ? 'en' : 'fr');
        }, 7500);
      })();
    </script>
  </body>
</html>